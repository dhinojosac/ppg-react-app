package main

import (
	"fmt"
	"net/http"
	"time"

	"github.com/gorilla/websocket"
)

var data = []float64{8586.000000, 8579.000000, 8594.000000, 8581.000000, 8588.000000, 8563.000000, 8566.000000, 8552.000000, 8544.000000, 8529.000000, 8527.000000, 8523.000000, 8519.000000, 8501.000000, 8489.000000, 8470.000000, 8457.000000, 8445.000000, 8457.000000, 8474.000000, 8491.000000, 8519.000000, 8590.000000, 8674.000000, 8761.000000, 8830.000000, 8884.000000, 8901.000000, 8884.000000, 8883.000000, 8854.000000, 8818.000000, 8779.000000, 8730.000000, 8675.000000, 8641.000000, 8600.000000, 8571.000000, 8552.000000, 8535.000000, 8542.000000, 8546.000000, 8587.000000, 8620.000000, 8677.000000, 8728.000000, 8815.000000, 8891.000000, 8995.000000, 9084.000000, 9203.000000, 9317.000000, 9416.000000, 9503.000000, 9567.000000, 9588.000000, 9601.000000, 9572.000000, 9506.000000, 9433.000000, 9323.000000, 9216.000000, 9105.000000, 8989.000000, 8874.000000, 8784.000000, 8702.000000, 8660.000000, 8607.000000, 8598.000000, 8579.000000, 8611.000000, 8612.000000, 8617.000000, 8613.000000, 8623.000000, 8620.000000, 8632.000000, 8635.000000, 8638.000000, 8630.000000, 8619.000000, 8608.000000, 8594.000000, 8592.000000, 8570.000000, 8563.000000, 8539.000000, 8532.000000, 8528.000000, 8545.000000, 8551.000000, 8573.000000, 8576.000000, 8601.000000, 8612.000000, 8640.000000, 8654.000000, 8685.000000, 8717.000000}
var index = 0

type Message struct {
	Name string      `json:"name"`
	Data interface{} `json:"data"`
}

var upgrader = websocket.Upgrader{
	ReadBufferSize:  1024,
	WriteBufferSize: 1024,
	CheckOrigin:     func(r *http.Request) bool { return true },
}

func main() {
	http.HandleFunc("/", handler)
	http.ListenAndServe(":4000", nil)
}

func handler(w http.ResponseWriter, r *http.Request) {

	socket, err := upgrader.Upgrade(w, r, nil)
	if err != nil {
		return
	}

	for {
		sendData(socket)
	}

}

func sendData(socket *websocket.Conn) {
	for {
		if index >= len(data) {
			index = 0
		}
		time.Sleep(time.Millisecond * 200)
		val := fmt.Sprintf("%f", data[index])
		mesage := Message{"ppg", val}
		socket.WriteJSON(mesage)
		fmt.Println("sent ppg data")
		index++
	}
}
